<?xml version="1.0"?>
<project name="crazyfm" basedir="." default="package">

    <property environment="env."/>
    <property name="FLEX_HOME" location="${env.FLEX_HOME}"/>

    <property name="path" value="."/>
    <property file="common.properties"/>
    <property name="libs_path" value="${basedir}/../../dependencies"/>
    <property name="flexunit" value="${basedir}/../../flexunit"/>

    <taskdef resource="flexTasks.tasks" classpath="${FLEX_HOME}/ant/lib/flexTasks.jar" />

    <target name="package" depends="clean,package_all_modules,asdoc"/>
    <target name="increase_minor_versions">
        <ant antfile="build.xml" target="increase_minor_version" dir="${basedir}/../../core" inheritall="false"/>
        <ant antfile="build.xml" target="increase_minor_version" dir="${basedir}/../../extensions/starlingApp" inheritall="false"/>
        <ant antfile="build.xml" target="increase_minor_version" dir="${basedir}/../../extensions/gearSys" inheritall="false"/>
        <ant antfile="build.xml" target="increase_minor_version" dir="${basedir}/../../extensions/physics" inheritall="false"/>
        <ant antfile="build.xml" target="increase_minor_version" dir="${basedir}/../../extensions/flashPhysicsEditor" inheritall="false"/>
    </target>
    <target name="package_all_modules">
        <echo>[package_all_modules] Packaging core, all extensions...</echo>
        <ant antfile="build.xml" target="package_swc" dir="${basedir}/../../core" inheritall="false"/>
        <ant antfile="build.xml" target="package_swc" dir="${basedir}/../../extensions/starlingApp" inheritall="false"/>
        <ant antfile="build.xml" target="package_swc" dir="${basedir}/../../extensions/gearSys" inheritall="false"/>
        <ant antfile="build.xml" target="package_swc" dir="${basedir}/../../extensions/physics" inheritall="false"/>
        <ant antfile="build.xml" target="package_swc" dir="${basedir}/../../extensions/flashPhysicsEditor" inheritall="false"/>
    </target>
    <target name="build_all_modules">
        <echo>[build_all_modules] Building core, all extensions...</echo>
        <ant antfile="build.xml" target="build" dir="${basedir}/../../core" inheritall="false"/>
        <ant antfile="build.xml" target="build" dir="${basedir}/../../extensions/starlingApp" inheritall="false"/>
        <ant antfile="build.xml" target="build" dir="${basedir}/../../extensions/gearSys" inheritall="false"/>
        <ant antfile="build.xml" target="build" dir="${basedir}/../../extensions/physics" inheritall="false"/>
        <ant antfile="build.xml" target="build" dir="${basedir}/../../extensions/flashPhysicsEditor" inheritall="false"/>
    </target>
    <target name="asdoc">
        <echo>-----------------------------------</echo>
        <echo>[asdoc] Generating framework ASDOC documentation...</echo>
        <echo>-----------------------------------</echo>
        <delete dir="${libs_path}/crazyfm/doc"/>
        <asdoc output="${libs_path}/crazyfm/doc" dir="${FLEX_HOME}" lenient="true" failonerror="true">
            <!-- core -->
            <doc-sources path-element="${basedir}/../../core/src"/>
            <!--exclude-sources path-element="core/src/com/crazyfm/mvc/controller" /-->
            <!-- extensions -->
            <doc-sources path-element="${basedir}/../../extensions/starlingApp/src"/>
            <doc-sources path-element="${basedir}/../../extensions/gearSys/src"/>
            <doc-sources path-element="${basedir}/../../extensions/physics/src"/>
            <doc-sources path-element="${basedir}/../../extensions/flashPhysicsEditor/src"/>
            <!-- external libs -->
            <external-library-path dir="${basedir}/../../extensions/starlingApp/dependencies" includes="*.swc"/>
            <external-library-path dir="${basedir}/../../extensions/gearSys/dependencies" includes="*.swc"/>
            <external-library-path dir="${basedir}/../../extensions/physics/dependencies" includes="*.swc"/>
            <external-library-path dir="${basedir}/../../extensions/flashPhysicsEditor/dependencies" includes="*.swc"/>

            <external-library-path dir="${FLEX_HOME}/frameworks/libs/player/${target-player}" includes="*"/>
        </asdoc>
    </target>
    <target name="upload_docs">
        <sshexec host="${sftp-host}"
                 username="${sftp-login}"
                 password="${sftp-password}"
                 command="${sftp-script-path} ${sftp-path}/doc"
                 trust="true"
        />
        <scp todir="${sftp-login}:${sftp-password}@${sftp-host}:${sftp-path}/doc" trust="true">
            <fileset dir="${libs_path}/crazyfm/doc"/>
        </scp>
        <echo>${sftp-host} ${sftp-login} ${sftp-password} ${sftp-script-path} ${sftp-path}</echo>
    </target>
    <target name="upload_swcs_zip">
        <zip destfile="${libs_path}/crazyfm/crazyfm_latest.zip"
             basedir="${libs_path}/crazyfm"
        />
        <scp file="${libs_path}/crazyfm/crazyfm_latest.zip" todir="${sftp-login}:${sftp-password}@${sftp-host}:${sftp-path}" trust="true"/>
        <delete file="${libs_path}/crazyfm/crazyfm_latest.zip"/>
    </target>
    <target name="clean">
        <echo>-----------------------------------</echo>
        <echo>[clean] Cleaning build directory...</echo>
        <echo>-----------------------------------</echo>
        <delete dir="${libs_path}/crazyfm"/>
    </target>
</project>
